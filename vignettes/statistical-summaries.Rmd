---
title: "Statistical Summaries with nightowl"
author: "nightowl Development Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Statistical Summaries with nightowl}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  dpi = 96
)
```

# Statistical Summaries in Clinical Research

The **Summary** R6 class and `summarise_*` function family in nightowl provide comprehensive statistical analysis capabilities designed specifically for clinical research workflows. This vignette demonstrates the full range of statistical summary options available.

## Setup and Data Preparation

```{r setup}
library(nightowl)
library(dplyr)
library(ggplot2)

# Load Palmer Penguins for consistent examples
if (requireNamespace("palmerpenguins", quietly = TRUE)) {
  data(penguins, package = "palmerpenguins")
} else {
  # Create synthetic data if palmerpenguins not available
  penguins <- data.frame(
    species = sample(c("Adelie", "Chinstrap", "Gentoo"), 300, replace = TRUE),
    island = sample(c("Biscoe", "Dream", "Torgersen"), 300, replace = TRUE),
    bill_length_mm = rnorm(300, 44, 6),
    bill_depth_mm = rnorm(300, 17, 2),
    flipper_length_mm = rnorm(300, 200, 15),
    body_mass_g = rnorm(300, 4200, 800),
    sex = sample(c("male", "female"), 300, replace = TRUE)
  )
}

# Create additional clinical-style data
clinical_data <- data.frame(
  patient_id = 1:200,
  treatment_arm = sample(c("Treatment A", "Treatment B", "Control"), 200, replace = TRUE),
  age = round(rnorm(200, 65, 12)),
  response_score = round(rnorm(200, 75, 20)),
  adverse_events = sample(c("None", "Mild", "Moderate", "Severe"), 200, replace = TRUE, prob = c(0.4, 0.3, 0.2, 0.1)),
  biomarker_level = rlnorm(200, meanlog = 3, sdlog = 0.5)
)
```

# Summary R6 Class Architecture

The Summary class provides a powerful, object-oriented approach to statistical analysis with method chaining capabilities.

## Basic Summary Creation

```{r summary-basic}
# Create a basic summary object
species_summary <- Summary$new(
  data = penguins, 
  column = "species",
  method = summarise_categorical
)

# Display the summary
species_summary$reactable()
```

## Method Chaining Workflow

```{r method-chaining}
# Demonstrate fluent method chaining
penguins %>%
  Summary$new("bill_length_mm", group_by = "species", method = summarise_numeric_pointrange) %>%
  .$reactable()
```

# Categorical Data Analysis

## Basic Categorical Summaries

```{r categorical-basic}
# Standard categorical summary
island_summary <- Summary$new(
  data = penguins,
  column = "island", 
  method = summarise_categorical
)

island_summary$reactable()
```

## Grouped Categorical Analysis

```{r categorical-grouped}
# Categorical summary by groups
species_by_island <- Summary$new(
  data = penguins %>% group_by(island),
  column = "species",
  method = summarise_categorical
)

species_by_island$reactable()
```

## Categorical Bar Plot Summaries

```{r categorical-barplot}
# Enhanced categorical summary with embedded bar plots
species_barplot <- Summary$new(
  data = penguins %>% group_by(island),
  column = "species",
  method = summarise_categorical_barplot
)

species_barplot$reactable()
```

## Clinical Application - Adverse Events

```{r clinical-categorical}
# Clinical adverse events analysis
ae_summary <- Summary$new(
  data = clinical_data,
  column = "adverse_events",
  group_by = "treatment_arm",
  method = summarise_categorical_barplot
)

ae_summary$reactable()
```

# Numeric Data Analysis

## Point Range Summaries

```{r numeric-pointrange}
# Numeric summary with point estimates and confidence intervals
bill_length_summary <- Summary$new(
  data = penguins,
  column = "bill_length_mm",
  group_by = "species",
  method = summarise_numeric_pointrange
)

bill_length_summary$reactable()
```

## Violin Plot Summaries

```{r numeric-violin}
# Numeric summary with embedded violin plots
body_mass_violin <- Summary$new(
  data = penguins,
  column = "body_mass_g",
  group_by = "species", 
  method = summarise_numeric_violin
)

body_mass_violin$reactable()
```

## Histogram Summaries

```{r numeric-histogram}
# Numeric summary with embedded histograms
flipper_histogram <- Summary$new(
  data = penguins,
  column = "flipper_length_mm",
  group_by = "species",
  method = summarise_numeric_histogram
)

flipper_histogram$reactable()
```

## Clinical Application - Biomarker Analysis

```{r clinical-numeric}
# Clinical biomarker analysis across treatment arms
biomarker_summary <- Summary$new(
  data = clinical_data,
  column = "biomarker_level",
  group_by = "treatment_arm",
  method = summarise_numeric_pointrange
)

biomarker_summary$reactable()
```

# Advanced Summary Techniques

## Custom Calculations

```{r custom-calculations}
# Create summary with custom calculations
age_summary <- Summary$new(
  data = clinical_data,
  column = "age",
  group_by = "treatment_arm",
  method = summarise_numeric_pointrange
)

# Add custom calculations
age_summary$add_calculation(list(
  "Missing" = function(x) sum(is.na(x)),
  "Range" = function(x) paste(min(x, na.rm = TRUE), "-", max(x, na.rm = TRUE))
))

age_summary$reactable()
```

## Multiple Output Formats

### HTML Table Output

```{r html-output}
# Generate HTML table with custom styling
html_summary <- Summary$new(
  data = penguins,
  column = "bill_depth_mm",
  group_by = "species",
  method = summarise_numeric_pointrange
)

html_summary$html()
```

### Kable Output

```{r kable-output}
# Generate kable output for reporting
kable_summary <- Summary$new(
  data = clinical_data,
  column = "response_score", 
  group_by = "treatment_arm",
  method = summarise_numeric_pointrange
)

kable_summary$kable()
```

### Raw Data Access

```{r raw-output}
# Access raw calculation results
raw_summary <- Summary$new(
  data = penguins,
  column = "body_mass_g",
  group_by = "species",
  method = summarise_numeric_pointrange
)

# View raw results structure
str(raw_summary$raw(), max.level = 2)
```

# Comprehensive Clinical Workflow

## Multi-Variable Analysis Dashboard

```{r clinical-dashboard}
# Create comprehensive clinical summary dashboard

# Demographics summary
demographics <- Summary$new(
  data = clinical_data,
  column = "age",
  group_by = "treatment_arm", 
  method = summarise_numeric_pointrange
)

cat("## Patient Demographics\n")
demographics$reactable()

# Treatment response analysis
cat("\n## Treatment Response\n")
response <- Summary$new(
  data = clinical_data,
  column = "response_score",
  group_by = "treatment_arm",
  method = summarise_numeric_violin
)

response$reactable()

# Safety profile
cat("\n## Safety Profile\n")
safety <- Summary$new(
  data = clinical_data,
  column = "adverse_events",
  group_by = "treatment_arm",
  method = summarise_categorical_barplot
)

safety$reactable()
```

## Biomarker Stratification Analysis

```{r biomarker-stratification}
# Create biomarker stratification for subgroup analysis
clinical_data <- clinical_data %>%
  mutate(
    biomarker_high = ifelse(biomarker_level > median(biomarker_level), "High", "Low")
  )

# Stratified response analysis
stratified_response <- Summary$new(
  data = clinical_data,
  column = "response_score",
  group_by = "biomarker_high",
  method = summarise_numeric_pointrange
)

stratified_response$reactable()
```

# Advanced Customization

## Styling and Theming

```{r styling-customization}
# Customize Summary appearance with options
styled_summary <- Summary$new(
  data = penguins,
  column = "bill_length_mm",
  group_by = "species",
  method = summarise_numeric_pointrange,
  options_reactables = list(
    defaultPageSize = 10,
    searchable = TRUE,
    striped = TRUE
  )
)

styled_summary$reactable()
```

## Statistical Test Integration

```{r statistical-tests}
# Summary with integrated statistical tests
test_summary <- Summary$new(
  data = clinical_data,
  column = "response_score",
  group_by = "treatment_arm",
  method = summarise_numeric_pointrange,
  options_test = list(
    test_type = "kruskal.test",
    alpha = 0.05
  )
)

test_summary$reactable()
```

# Performance Considerations

## Large Dataset Handling

```{r performance-tips, eval=FALSE}
# For large clinical datasets, consider these optimizations:

# 1. Use sampling for exploratory analysis
large_data_sample <- clinical_data %>% 
  sample_n(min(1000, nrow(clinical_data)))

# 2. Pre-group data to reduce computation
pre_grouped_data <- clinical_data %>%
  group_by(treatment_arm)

# 3. Cache summary objects for repeated use
cached_summary <- Summary$new(
  data = pre_grouped_data,
  column = "response_score",
  method = summarise_numeric_pointrange
)

# Store for later use
saveRDS(cached_summary, "cached_summary.rds")
```

## Memory Optimization

```{r memory-optimization, eval=FALSE}
# For memory-efficient analysis:

# 1. Process data in chunks
process_chunk <- function(chunk_data) {
  Summary$new(
    data = chunk_data,
    column = "outcome_variable",
    group_by = "treatment",
    method = summarise_numeric_pointrange
  )$raw()
}

# 2. Clear unnecessary objects
rm(large_temporary_object)
gc()  # Force garbage collection
```

# Integration with Reporting Workflows

## R Markdown Integration

```{r rmarkdown-integration, eval=FALSE}
# Seamless integration with R Markdown reports

# Create summary tables programmatically
summary_list <- list(
  demographics = Summary$new(data, "age", "treatment", summarise_numeric_pointrange),
  efficacy = Summary$new(data, "response", "treatment", summarise_numeric_violin),
  safety = Summary$new(data, "adverse_events", "treatment", summarise_categorical)
)

# Generate all tables
purrr::map(summary_list, ~.x$reactable())
```

## Export Capabilities

```{r export-capabilities, eval=FALSE}
# Export summaries for external reporting

# Export to Excel
summary_data <- Summary$new(
  data = clinical_data,
  column = "response_score",
  group_by = "treatment_arm", 
  method = summarise_numeric_pointrange
)$raw()

# Convert to data frame for export
export_df <- summary_data %>%
  purrr::map_dfr(~as.data.frame(.x), .id = "summary_type")

write.csv(export_df, "clinical_summary.csv")
```

# Best Practices for Clinical Research

## Reproducible Analysis Workflow

1. **Document Data Sources**: Always document data provenance and preprocessing steps
2. **Version Control**: Track analysis versions and maintain audit trails
3. **Validation**: Cross-validate summary statistics with independent methods
4. **Quality Assurance**: Implement automated checks for data quality

## Statistical Considerations

1. **Multiple Comparisons**: Adjust for multiple testing when appropriate
2. **Missing Data**: Handle missing data transparently and consistently
3. **Effect Sizes**: Report both statistical significance and clinical significance
4. **Subgroup Analysis**: Pre-specify subgroup analyses to avoid data dredging

## Regulatory Compliance

```{r regulatory-compliance, eval=FALSE}
# Ensure regulatory compliance in clinical summaries

# 1. Include data provenance
summary_with_metadata <- Summary$new(
  data = clinical_data,
  column = "primary_endpoint",
  group_by = "treatment_arm",
  method = summarise_numeric_pointrange
)

# 2. Add analysis metadata
attr(summary_with_metadata, "analysis_date") <- Sys.Date()
attr(summary_with_metadata, "analyst") <- "Study Statistician"
attr(summary_with_metadata, "protocol_version") <- "2.1"

# 3. Generate audit trail
analysis_log <- data.frame(
  timestamp = Sys.time(),
  analysis_type = "Summary Statistics",
  dataset = "clinical_data",
  variables = "primary_endpoint",
  method = "summarise_numeric_pointrange"
)
```

# Conclusion

The nightowl Summary system provides a comprehensive, flexible framework for statistical analysis in clinical research. Key advantages include:

- **R6 Architecture**: Object-oriented design with method chaining
- **Multiple Output Formats**: reactable, HTML, kable, and raw data access
- **Visualization Integration**: Embedded plots within summary tables
- **Clinical Focus**: Designed specifically for research and healthcare applications
- **Reproducibility**: Consistent, documented analysis workflows

## Next Steps

- Explore [Survival Analysis](survival-analysis.html) for time-to-event data
- Learn about [Advanced Plotting](getting-started.html) for data visualization  
- Review the [Package Reference](../reference/) for complete function documentation

---

*This vignette demonstrates the comprehensive statistical summary capabilities of nightowl. For specific clinical applications and advanced techniques, please refer to the additional vignettes and package documentation.*