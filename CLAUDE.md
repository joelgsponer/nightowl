# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

`nightowl` is an R package for statistical visualization and analysis, focused on clinical research applications. It provides a declarative plotting system built on ggplot2 with R6 classes, survival analysis capabilities, and interactive visualizations.

## Core Architecture

### R6 Class System
The package is built around three main R6 classes:
- **Plot**: Main plotting class in `R/plot.R` with SVG rendering, HTML output, and memoization
- **Summary**: Statistical summaries in `R/Summary.r` with data aggregation and table generation  
- **Coxph**: Cox proportional hazards modeling in `R/coxph.R` for survival analysis

### Key Components
- **Plotting**: Declarative plotting system with layers, themes, and customizable styling
- **Statistical Analysis**: Built-in statistical tests (chi-square, t-tests, Kruskal-Wallis)
- **Survival Analysis**: Kaplan-Meier curves and Cox regression with forest plots
- **Interactive Elements**: SVG rendering with hover effects and reactable tables
- **Performance**: Memoization and caching system for large datasets

## Development Commands

### Testing
```bash
# Run all tests
devtools::test()

# Run specific test file
devtools::test(filter = "test-plot")

# Check package
devtools::check()
```

### Building and Documentation
```bash
# Build package (via Makefile)
make build

# Install package only
make install

# Manual documentation update
devtools::document()

# Build pkgdown site
pkgdown::build_site()
```

### Code Style
The Makefile includes `styler::style_dir(".")` for consistent formatting.

## File Structure

### Core R Files
- `R/plot.R` - Main Plot R6 class with rendering capabilities
- `R/Summary.r` - Summary R6 class for statistical summaries
- `R/coxph.R` - Coxph R6 class for survival analysis
- `R/forest.R` - Forest plot implementations
- `R/km.R` - Kaplan-Meier survival curves
- `R/summaries.R` - Summary functions (`summarise_*` family)
- `R/inline_plots.R` - Inline plotting functions
- `R/reactable.R` - Interactive table rendering

### Testing
- Tests use `testthat` framework in `tests/testthat/`
- Security tests in `test-security-formula-construction.R`
- Performance benchmarks in `test-performance-benchmarks.R`
- Visual regression tests in `test-visual-regression.R`

### Package Configuration  
- `DESCRIPTION` - Package dependencies and metadata
- `NAMESPACE` - Generated by roxygen2, do not edit manually
- `Makefile` - Build and development commands

## Dependencies

Core dependencies include:
- **Visualization**: ggplot2, ggpubr, patchwork, reactable
- **Data**: dplyr, tidyr, purrr, magrittr
- **Statistics**: survival, GGally
- **Interactive**: ggiraph, htmltools
- **Performance**: memoise, furrr

## Key Design Patterns

### Method Chaining
The R6 classes support method chaining for fluent interfaces:
```r
Summary$new(data, "column", method = summarise_numeric_pointrange) %>%
  reactable()
```

### Lazy Evaluation
Plot rendering is memoized and occurs on demand for performance.

### Security
Formula construction includes security validation to prevent code injection (see `test-security-formula-construction.R`).

### Data Parameter Migration
Recent development replaced `.data` parameter with `data` across functions - check for any remaining `.data` usage if issues arise.